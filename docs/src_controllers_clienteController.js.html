<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: src/controllers/clienteController.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: src/controllers/clienteController.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const { clienteModel } = require('../models/clienteModel');

/**
 * Controller responsável pelas operações de Clientes (CRUD).
 * @module controllers/clienteController
 */

/**
 * Função auxiliar para buscar endereço via API externa (ViaCEP).
 * @async
 * @function buscarCep
 * @param {string} cep - O CEP a ser consultado (pode conter traços ou pontos).
 * @returns {Promise&lt;Object>} Retorna o objeto com logradouro, bairro, etc.
 * @throws {Error} Lança erro se o CEP for inválido ou não encontrado.
 */
async function buscarCep(cep) {
    const limpa = cep.replace(/\D/g, '');
    if (cep.length != 8) {
        throw new Error('CEP inválido!');
    }
    const response = await fetch(`https://viacep.com.br/ws/${limpa}/json/`);

    console.log(response);

    const data = await response.json();

    if (data.erro) {
        throw new Error('CEP não encontrado');
    }
    return data;

};



const clienteController = {

    /**
     * Lista todos os clientes ou busca um específico pelo ID.
     * Rota: GET /clientes
     * @async
     * @function listarClientes
     * @param {Object} req - Objeto da requisição. Aceita `idCliente` via query param (?idCliente=1).
     * @param {Object} res - Objeto da resposta.
     * @returns {Promise&lt;void>} Retorna JSON com a lista de clientes ou mensagem de "não encontrado".
     */
    listarClientes: async (req, res) => {
        try {
            const idCliente = req.query.idCliente;
            const consulta = idCliente ? clienteModel.selectClienteById(idCliente) : clienteModel.listarCliente();
            const resultado = await consulta;
            if (resultado.length === 0) {
                return res.status(200).json({ message: 'A consulta não retornou resultados' });
            }
            res.status(200).json({ message: 'Consulta bem sucedida!', data: resultado });

        } catch (error) {
            console.error(error);
            res.status(500).json({
                message: `Ocorreu um erro no servidor`,
                errorMessage: error.message
            });
        }
    },

    /**
     * Insere um novo cliente completo (com endereço e telefones).
     * Rota: POST /clientes
     * @async
     * @function insertClienteCompleto
     * @param {Object} req - Objeto da requisição.
     * @param {Object} req.body - Corpo da requisição contendo: nome, cpf, email, cep, numero, complemento, telefones.
     * @param {Object} res - Objeto da resposta.
     * @returns {Promise&lt;void>} Retorna 201 (Criado) ou erros de validação (400) e conflito (409).
     */
    insertClienteCompleto: async (req, res) => {
        try {
            const { nome, cpf, email, cep, numero, complemento, telefones } = req.body;

            if (!nome || !cpf || !email || !cep || !numero || !complemento || !telefones) {
                return res.status(400).json({ message: 'Verifique os dados enviados e tente novamente' });
            }

            if (!Array.isArray(telefones) || telefones.length === 0) {
                return res.status(400).json({ message: 'Informe pelo menos um telefone válido' });
            }

            if (cpf.length !== 11) {
                return res.status(400).json({ message: 'CPF inválido! O CPF deve ter 11 dígitos.' });
            }

            const cpfExistente = await clienteModel.selectByCpf(cpf)

            if (cpfExistente &amp;&amp; cpfExistente.length > 0) {
                return res.status(409).json({ message: `O CPF informado já existe no sistema. Não foi possivel realizar a inserção` });
            }

            const dadosCep = await buscarCep(cep);

            const endereco = {
                rua: dadosCep.logradouro,
                bairro: dadosCep.bairro,
                cidade: dadosCep.localidade,
                uf: dadosCep.uf,
                cep,
                numero,
                complemento
            };

            const result = await clienteModel.insertClienteCompleto(
                nome, cpf, email, endereco, telefones
            );

            res.status(201).json({ message: 'Registro incluindo com sucesso', data: result });

        } catch (error) {
            console.error(error);
            res.status(500).json({
                message: `Ocorreu um erro no servidor`,
                errorMessage: error.message
            });
        }
    },

    /**
 * Atualiza os dados de um cliente existente.
 * Rota: PUT /clientes/:idCliente
 * @async
 * @function atualizarCliente
 * @param {Object} req - Objeto da requisição. Espera `idCliente` na URL.
 * @param {Object} res - Objeto da resposta.
 * @returns {Promise&lt;void>} Retorna status da alteração.
 */
    atualizarCliente: async (req, res) => {
        try {
            const { idCliente } = req.params;
            const dados = req.body;

            if (!dados) {
                return res.status(400).json({ message: 'Verifique os dados enviados e tente novamente' });
            };

            const cpfExistente = await clienteModel.selectByCpf(dados.cpf)

            if (cpfExistente &amp;&amp; cpfExistente.length > 0) {
                return res.status(409).json({ message: 'O CPF informado já existe no sistema. Não foi possivel realizar a alteração' });
            }

            const clienteAtual = await clienteModel.selectClienteById(idCliente);

            if (clienteAtual.length === 0) {
                return res.status(200).json({ message: 'Cliente não localizado' });
            };

            const resultUpdate = await clienteModel.updateClienteCompleto(idCliente, dados);

            if (resultUpdate.affectedRows === 1 &amp;&amp; resultUpdate.changedRows === 0) {
                return res.status(200).json({ message: 'Não há alterações a serem realizadas.' });
            };

            if (resultUpdate.changedRows > 0) {
                res.status(200).json({ message: 'O registro foi alterado com sucesso.' });
            };


        } catch (error) {
            console.error(error);
            res.status(500).json({
                message: "Erro no servidor",
                errorMessage: error.message
            });
        }
    },

    /**
 * Remove um cliente do sistema.
 * Rota: DELETE /clientes/:idCliente
 * @async
 * @function excluirCliente
 * @param {Object} req - Objeto da requisição. Espera `idCliente` na URL.
 * @param {Object} res - Objeto da resposta.
 * @returns {Promise&lt;void>} Retorna mensagem de sucesso ou cliente não encontrado.
 */
    excluirCliente: async (req, res) => {
        try {
            const { idCliente } = req.params;

            const resultado = await clienteModel.deleteCliente(idCliente);

            if (resultado.affectedRows === 0) {
                return res.status(200).json({ message: "cliente não encontrado" });
            }

            res.status(200).json({ message: "cliente deletado" });

        } catch (error) {
            console.error(error);
            res.status(500).json({
                message: `Ocorreu um erro no servidor`,
                errorMessage: error.message
            });
        }
    }
};

module.exports = { clienteController };
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-config_db.html">config/db</a></li><li><a href="module-controllers_clienteController.html">controllers/clienteController</a></li><li><a href="module-controllers_pedidoController.html">controllers/pedidoController</a></li><li><a href="module-models_clienteModel.html">models/clienteModel</a></li><li><a href="module-models_pedidoModel.html">models/pedidoModel</a></li><li><a href="module-routes_clienteRoutes.html">routes/clienteRoutes</a></li><li><a href="module-routes_index.html">routes/index</a></li><li><a href="module-routes_pedidoRoutes.html">routes/pedidoRoutes</a></li></ul><h3>Global</h3><ul><li><a href="global.html#PORT">PORT</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.5</a> on Wed Dec 10 2025 09:09:32 GMT-0300 (Horário Padrão de Brasília)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
